<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>Chapter 11ï¼šå·¥ç¨‹åŒ–å®è·µï¼šä»è„šæœ¬åˆ°ç”Ÿäº§çº§æµæ°´çº¿</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">é¢å‘é€ å¯¹è¯æ•°æ®çš„ Wikidata ä½¿ç”¨æ•™ç¨‹ï¼ˆç”¨äºç”Ÿæˆå¤šæ ·åŒ–ä¸»é¢˜ï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 1ï¼šWikidata ä¸å¯¹è¯æ•°æ®ï¼šä¸ºä»€ä¹ˆå®ƒé€‚åˆåšâ€œå¤šæ ·åŒ–ä¸»é¢˜â€</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 2ï¼šWikidata æ•°æ®æ¨¡å‹è¯¦è§£ï¼ˆQ/P/å£°æ˜/é™å®šç¬¦/å¼•ç”¨ï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 3ï¼šWDQS å…¥é—¨ï¼šç”¨ SPARQL æŠŠçŸ¥è¯†â€œæŸ¥å‡ºæ¥â€</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 4ï¼šä¸»é¢˜ç”Ÿæˆï¼šä»çŸ¥è¯†å›¾è°±é‡‡æ ·â€œå¤šæ ·åŒ–ä¸»é¢˜æ± â€</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 5ï¼šæŠŠäº‹å®å˜æˆå¯¹è¯ï¼šå¤šè½®ç»“æ„ä¸æ ‡æ³¨æ–¹æ¡ˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 6ï¼šè‡ªåŠ¨åŒ–æŠ“å–ä¸ç¼“å­˜ï¼šä» WDQS åˆ°æœ¬åœ°æ•°æ®ç®¡é“</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 7ï¼šä¸­æ–‡è‡ªç„¶è¯­è¨€ç”Ÿæˆï¼šä»ä¸‰å…ƒç»„åˆ°å£è¯­åŒ–è¡¨è¾¾</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 8ï¼šè´¨é‡æ§åˆ¶ä¸è¯„ä¼°ä½“ç³»ï¼šæ„å»ºæ•°æ®æµæ°´çº¿çš„â€œè´¨æ£€å±€â€</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 9ï¼šå¤šè¯­è¨€ä¸ä¸­æ–‡ç¼ºå¤±å¤„ç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 10ï¼šè®¸å¯ä¸åˆè§„ï¼šWikidata CC0 ä¸å¯¹è¯æ•°æ®å‘å¸ƒæ³¨æ„äº‹é¡¹</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 11ï¼šå·¥ç¨‹åŒ–å®è·µï¼šä»è„šæœ¬åˆ°ç”Ÿäº§çº§æµæ°´çº¿</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 12ï¼šæŸ¥è¯¢æ¨¡æ¿åº“ä¸é€ŸæŸ¥è¡¨ (Appendices)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="chapter-11">Chapter 11ï¼šå·¥ç¨‹åŒ–å®è·µï¼šä»è„šæœ¬åˆ°ç”Ÿäº§çº§æµæ°´çº¿</h1>
<p>åœ¨å‰é¢çš„ç« èŠ‚ä¸­ï¼Œä½ å¯èƒ½å·²ç»ç”¨ Python è„šæœ¬è·‘é€šè¿‡å‡ ä¸ª SPARQL æŸ¥è¯¢ï¼Œå¹¶ç”¨ç®€å•çš„å­—ç¬¦ä¸²æ›¿æ¢ç”Ÿæˆäº†ä¸€äº›å¯¹è¯ã€‚è¿™å¯¹äºéªŒè¯æƒ³æ³•ï¼ˆPoCï¼‰å¾ˆå¥½ï¼Œä½†å¦‚æœä½ éœ€è¦ç”Ÿäº§<strong>ç™¾ä¸‡çº§</strong>æ•°æ®ã€æ”¯æŒ<strong>æ¯å‘¨æ›´æ–°</strong>ã€æˆ–è€…éœ€è¦<strong>å¤šäººåä½œ</strong>ï¼Œè¿™ç§â€œæ‰‹å·¥ä½œåŠâ€æ¨¡å¼å¾ˆå¿«å°±ä¼šå´©æºƒã€‚</p>
<p>æœ¬ç« å°†æ•™ä½ å¦‚ä½•å°†å®éªŒä»£ç é‡æ„ä¸º<strong>å¥å£®ã€å¯å¤ç°ã€å¯ç›‘æ§çš„ç”Ÿäº§çº§æ•°æ®æµæ°´çº¿</strong>ã€‚</p>
<hr />
<h2 id="_1">æœ¬ç« å­¦ä¹ ç›®æ ‡</h2>
<ol>
<li><strong>å·¥ç¨‹æ¶æ„</strong>ï¼šæŒæ¡ E-T-L-Eï¼ˆExtract-Transform-Load-Evaluateï¼‰åœ¨æ•°æ®åˆæˆä¸­çš„åº”ç”¨ã€‚</li>
<li><strong>é²æ£’æ€§è®¾è®¡</strong>ï¼šå¤„ç†ç½‘ç»œæŠ–åŠ¨ã€API é€Ÿç‡é™åˆ¶ï¼ˆRate Limitingï¼‰å’Œæ–­ç‚¹ç»­è·‘ã€‚</li>
<li><strong>æ ‡å‡†åŒ–ä¸­é—´å±‚</strong>ï¼šä½¿ç”¨ Pydantic å®šä¹‰ä¸¥è°¨çš„æ•°æ® Schemaï¼ˆIRï¼‰ï¼Œè§£è€¦é‡‡é›†ä¸ç”Ÿæˆã€‚</li>
<li><strong>è´¨é‡ä¿éšœä½“ç³»</strong>ï¼šå»ºç«‹â€œé‡‘æ ·ï¼ˆGolden Setï¼‰â€å›å½’æµ‹è¯•ï¼Œé˜²æ­¢è§„åˆ™ä¿®æ”¹å¯¼è‡´çš„â€œè´è¶æ•ˆåº”â€ã€‚</li>
<li><strong>é¡¹ç›®ç»„ç»‡</strong>ï¼šä¸€ä¸ªæ ‡å‡†çš„æ•°æ®å·¥ç¨‹é¡¹ç›®è¯¥é•¿ä»€ä¹ˆæ ·ã€‚</li>
</ol>
<hr />
<h2 id="1">1. ç†æƒ³çš„ç›®å½•ç»“æ„</h2>
<p>åœ¨å¼€å§‹å†™ä»£ç å‰ï¼Œå…ˆæ•´ç†ä½ çš„å·¥ä½ã€‚ä¸€ä¸ªæ ‡å‡†åŒ–çš„ç›®å½•ç»“æ„èƒ½è®©ä½ çš„é¡¹ç›®æ¸…æ™°å¯ç»´æŠ¤ã€‚</p>
<div class="codehilite"><pre><span></span><code>wikidata-dialogue-synth/
â”œâ”€â”€ config/                 # é…ç½®ä¸­å¿ƒ
â”‚   â”œâ”€â”€ topic_schema.yaml   # å®šä¹‰è¦é‡‡æ ·çš„é¢†åŸŸã€æƒé‡
â”‚   â”œâ”€â”€ queries/            # SPARQL æ¨¡æ¿æ–‡ä»¶ (.sparql)
â”‚   â””â”€â”€ templates/          # è‡ªç„¶è¯­è¨€ç”Ÿæˆæ¨¡æ¿ (.jinja2 / .yaml)
â”œâ”€â”€ data/                   # æ•°æ®è½åœ°ï¼ˆé€šå¸¸åœ¨ .gitignore ä¸­å¿½ç•¥ï¼‰
â”‚   â”œâ”€â”€ 0_raw/              # åŸå§‹ SPARQL JSON å“åº”ï¼ˆç¼“å­˜å±‚ï¼‰
â”‚   â”œâ”€â”€ 1_intermediate/     # æ¸…æ´—åçš„æ ‡å‡†ä¸­é—´æ€æ•°æ® (JSONL/Parquet)
â”‚   â”œâ”€â”€ 2_final/            # æœ€ç»ˆç”Ÿæˆçš„å¯¹è¯æ•°æ®
â”‚   â””â”€â”€ goldens/            # æµ‹è¯•ç”¨çš„é‡‘æ ·æ•°æ®
â”œâ”€â”€ src/                    # æºä»£ç 
â”‚   â”œâ”€â”€ collector/          # é‡‡æ ·å™¨ï¼šè´Ÿè´£ä¸ Wikidata äº¤äº’
â”‚   â”œâ”€â”€ normalizer/         # æ¸…æ´—å™¨ï¼šè´Ÿè´£è„æ•°æ®å¤„ç†ã€ç±»å‹è½¬æ¢
â”‚   â”œâ”€â”€ generator/          # ç”Ÿæˆå™¨ï¼šè´Ÿè´£é€»è¾‘æ¸²æŸ“ã€LLM è°ƒç”¨
â”‚   â”œâ”€â”€ validator/          # è¯„ä¼°å™¨ï¼šè´Ÿè´£è´¨é‡æ‰“åˆ†ã€å»é‡
â”‚   â””â”€â”€ utils/              # é€šç”¨å·¥å…·ï¼ˆæ—¥å¿—ã€IOã€å“ˆå¸Œï¼‰
â”œâ”€â”€ tests/                  # å•å…ƒæµ‹è¯•ä¸å›å½’æµ‹è¯•
â”œâ”€â”€ scripts/                # å¯åŠ¨è„šæœ¬ (e.g., run_pipeline.sh)
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ Makefile                # å¸¸ç”¨æŒ‡ä»¤å¿«æ·æ–¹å¼
â””â”€â”€ README.md
</code></pre></div>

<hr />
<h2 id="2-the-e-t-s-v-pipeline">2. æµæ°´çº¿æ¶æ„è¯¦è§£ (The E-T-S-V Pipeline)</h2>
<p>æˆ‘ä»¬å°†ä¼ ç»Ÿçš„ ETL æ‰©å±•ä¸º <strong>ETSV</strong>ï¼šExtractï¼ˆé‡‡é›†ï¼‰ -&gt; Transformï¼ˆè§„èŒƒåŒ–ï¼‰ -&gt; Synthesizeï¼ˆåˆæˆï¼‰ -&gt; Validateï¼ˆéªŒè¯ï¼‰ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="n">graph</span><span class="w"> </span><span class="n">TD</span>
<span class="w">    </span><span class="n">subgraph</span><span class="w"> </span><span class="n">Config</span>
<span class="w">    </span><span class="n">C1</span><span class="p">[</span><span class="n">Topic</span><span class="w"> </span><span class="n">Config</span><span class="p">]</span>
<span class="w">    </span><span class="n">C2</span><span class="p">[</span><span class="n">SPARQL</span><span class="w"> </span><span class="n">Templates</span><span class="p">]</span>
<span class="w">    </span><span class="n">C3</span><span class="p">[</span><span class="n">Prompt</span><span class="o">/</span><span class="n">Jinja</span><span class="w"> </span><span class="n">Templates</span><span class="p">]</span>
<span class="w">    </span><span class="n">end</span>

<span class="w">    </span><span class="n">subgraph</span><span class="w"> </span><span class="n">Phase</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">Extraction</span>
<span class="w">    </span><span class="n">W</span><span class="p">[</span><span class="n">Wikidata</span><span class="w"> </span><span class="n">Query</span><span class="w"> </span><span class="n">Service</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;--&gt;|</span><span class="n">HTTP</span><span class="o">/</span><span class="n">Retry</span><span class="o">|</span><span class="w"> </span><span class="n">S</span><span class="p">[</span><span class="n">Sampler</span><span class="p">]</span>
<span class="w">    </span><span class="n">S</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">Raw</span><span class="w"> </span><span class="n">JSON</span><span class="o">|</span><span class="w"> </span><span class="n">D1</span><span class="p">[(</span><span class="n">Raw</span><span class="w"> </span><span class="n">Cache</span><span class="p">)]</span>
<span class="w">    </span><span class="n">end</span>

<span class="w">    </span><span class="n">subgraph</span><span class="w"> </span><span class="n">Phase</span><span class="w"> </span><span class="mi">2</span><span class="o">:</span><span class="w"> </span><span class="n">Normalization</span>
<span class="w">    </span><span class="n">D1</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">N</span><span class="p">[</span><span class="n">Normalizer</span><span class="p">]</span>
<span class="w">    </span><span class="n">N</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">Pydantic</span><span class="w"> </span><span class="n">Models</span><span class="o">|</span><span class="w"> </span><span class="n">D2</span><span class="p">[(</span><span class="n">Intermediate</span><span class="w"> </span><span class="n">Repr</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">IR</span><span class="p">)]</span>
<span class="w">    </span><span class="n">end</span>

<span class="w">    </span><span class="n">subgraph</span><span class="w"> </span><span class="n">Phase</span><span class="w"> </span><span class="mi">3</span><span class="o">:</span><span class="w"> </span><span class="n">Synthesis</span>
<span class="w">    </span><span class="n">D2</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">G</span><span class="p">[</span><span class="n">Generator</span><span class="p">]</span>
<span class="w">    </span><span class="n">C3</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">G</span>
<span class="w">    </span><span class="n">G</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">Dialogues</span><span class="o">|</span><span class="w"> </span><span class="n">D3</span><span class="p">[(</span><span class="n">Candidate</span><span class="w"> </span><span class="n">Dataset</span><span class="p">)]</span>
<span class="w">    </span><span class="n">end</span>

<span class="w">    </span><span class="n">subgraph</span><span class="w"> </span><span class="n">Phase</span><span class="w"> </span><span class="mi">4</span><span class="o">:</span><span class="w"> </span><span class="n">Validation</span>
<span class="w">    </span><span class="n">D3</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">V</span><span class="p">[</span><span class="n">Validator</span><span class="o">/</span><span class="n">Filter</span><span class="p">]</span>
<span class="w">    </span><span class="n">V</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">Pass</span><span class="o">|</span><span class="w"> </span><span class="n">D4</span><span class="p">[(</span><span class="n">Final</span><span class="w"> </span><span class="n">Dataset</span><span class="p">)]</span>
<span class="w">    </span><span class="n">V</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">Fail</span><span class="o">|</span><span class="w"> </span><span class="n">D5</span><span class="p">[</span><span class="n">Audit</span><span class="w"> </span><span class="n">Log</span><span class="p">]</span>
<span class="w">    </span><span class="n">end</span>

<span class="w">    </span><span class="n">C1</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">S</span>
<span class="w">    </span><span class="n">C2</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">S</span>
</code></pre></div>

<h3 id="21-the-samplercollector">2.1 é˜¶æ®µä¸€ï¼šé‡‡é›†å™¨ (The Sampler/Collector)</h3>
<p><strong>æ ¸å¿ƒæŒ‘æˆ˜</strong>ï¼šWikidata çš„ SPARQL ç«¯ç‚¹ï¼ˆWDQSï¼‰æå…¶ä¸ç¨³å®šï¼Œæœ‰ä¸¥æ ¼çš„é€Ÿç‡é™åˆ¶ï¼ˆRate Limitï¼‰å’Œè¶…æ—¶æ—¶é—´ï¼ˆ60ç§’ï¼‰ã€‚</p>
<p><strong>å·¥ç¨‹å®è·µ</strong>ï¼š</p>
<ol>
<li><strong>ç”¨æˆ·ä»£ç† (User-Agent)</strong>ï¼šå¿…é¡»è®¾ç½®ã€‚<ul>
<li><code>User-Agent: MyBot/1.0 (contact@example.com) tool/data-synth</code></li>
<li>ä¸è®¾ç½®ä¼šè¢«ç›´æ¥å°ç¦ã€‚</li>
</ul>
</li>
<li><strong>æŒ‡æ•°é€€é¿é‡è¯• (Exponential Backoff)</strong>ï¼š<ul>
<li>ä¸è¦ç”¨æ­»å¾ªç¯ <code>while True</code>ã€‚æ¨èä½¿ç”¨ Python çš„ <code>tenacity</code> åº“ã€‚</li>
<li>ç­–ç•¥ï¼šé‡åˆ° 429 (Too Many Requests) æˆ– 5xx é”™è¯¯ï¼Œç­‰å¾… 2s, 4s, 8s, 16s... åé‡è¯•ã€‚</li>
</ul>
</li>
<li><strong>åˆ†é¡µç­–ç•¥</strong>ï¼š<ul>
<li>ä¸è¦è¯•å›¾ä¸€æ¬¡æ‹‰å– <code>LIMIT 100000</code>ã€‚</li>
<li>ä½¿ç”¨ <code>OFFSET</code> æ•ˆç‡å¾ˆä½ã€‚<strong>æœ€ä½³å®è·µ</strong>æ˜¯åŸºäº ID æ’åºæˆ–æ—¶é—´æˆ³åˆ‡ç‰‡ã€‚</li>
</ul>
</li>
<li><strong>å¹‚ç­‰ç¼“å­˜ (Idempotent Caching)</strong>ï¼š<ul>
<li>è®¡ç®— SPARQL æŸ¥è¯¢å­—ç¬¦ä¸²çš„ MD5 å“ˆå¸Œå€¼ã€‚</li>
<li>åœ¨è¯·æ±‚å‰ï¼Œæ£€æŸ¥ <code>data/0_raw/{hash}.json</code> æ˜¯å¦å­˜åœ¨ã€‚å­˜åœ¨åˆ™ç›´æ¥è¯»å–ã€‚</li>
<li><strong>ä»·å€¼</strong>ï¼šå¼€å‘è°ƒè¯•æ—¶ï¼Œä½ å¯ä»¥éšæ„ä¿®æ”¹æ¸…æ´—é€»è¾‘ï¼Œè€Œæ— éœ€åå¤è½°ç‚¸ Wikidata æœåŠ¡å™¨ã€‚</li>
</ul>
</li>
</ol>
<p><strong>ä»£ç ç‰‡æ®µç¤ºä¾‹ (ä½¿ç”¨ Tenacity)</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">tenacity</span> <span class="kn">import</span> <span class="n">retry</span><span class="p">,</span> <span class="n">stop_after_attempt</span><span class="p">,</span> <span class="n">wait_exponential</span><span class="p">,</span> <span class="n">retry_if_exception_type</span>

<span class="nd">@retry</span><span class="p">(</span>
    <span class="n">stop</span><span class="o">=</span><span class="n">stop_after_attempt</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
    <span class="n">wait</span><span class="o">=</span><span class="n">wait_exponential</span><span class="p">(</span><span class="n">multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">60</span><span class="p">),</span>
    <span class="n">retry</span><span class="o">=</span><span class="n">retry_if_exception_type</span><span class="p">((</span><span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">,</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">))</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">fetch_sparql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;https://query.wikidata.org/sparql&quot;</span><span class="p">):</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;MyDataBot/1.0 (me@example.com)&quot;</span><span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">},</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">429</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">(</span><span class="s2">&quot;Rate Limited&quot;</span><span class="p">)</span> <span class="c1"># è§¦å‘é‡è¯•</span>

    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</code></pre></div>

<h3 id="22-the-normalizer">2.2 é˜¶æ®µäºŒï¼šè§„èŒƒåŒ–å™¨ (The Normalizer)</h3>
<p><strong>æ ¸å¿ƒæŒ‘æˆ˜</strong>ï¼šSPARQL è¿”å›çš„æ˜¯æå…¶å•°å—¦çš„ JSONï¼ˆåŒ…å« xml:lang, type, value ç­‰å­—æ®µï¼‰ï¼Œä¸”æ•°æ®è„ä¹±å·®ï¼ˆæ—¥æœŸæ ¼å¼ä¸ä¸€ã€å¤šå€¼ã€ç¼ºå¤±ï¼‰ã€‚</p>
<p><strong>å·¥ç¨‹å®è·µ</strong>ï¼š</p>
<ol>
<li><strong>ä¸­é—´è¡¨ç¤º (Intermediate Representation, IR)</strong>ï¼š<ul>
<li><strong>åˆ‡è®°</strong>ï¼šä¸è¦æŠŠåŸå§‹ JSON ç›´æ¥ä¼ ç»™ç”Ÿæˆå™¨ã€‚</li>
<li>å®šä¹‰ä¸€ä¸ªæ¸…æ™°ã€æ‰å¹³çš„ç»“æ„ã€‚</li>
</ul>
</li>
<li><strong>é˜²å¾¡æ€§ç¼–ç¨‹ (Pydantic)</strong>ï¼š<ul>
<li>ä½¿ç”¨ <code>pydantic</code> å®šä¹‰æ•°æ®æ¨¡å‹ã€‚å®ƒèƒ½åœ¨æ•°æ®æµå…¥ä¸‹ä¸€ç¯èŠ‚å‰è‡ªåŠ¨æ ¡éªŒç±»å‹ã€‚</li>
<li>å¦‚æœæ•°æ®ç¼ºå°‘å…³é”®å­—æ®µï¼ˆå¦‚ä¸­æ–‡åï¼‰ï¼Œåœ¨è¿™é‡Œå†³å®šæ˜¯<strong>ä¸¢å¼ƒ</strong>ã€<strong>å›é€€åˆ°è‹±æ–‡</strong>è¿˜æ˜¯<strong>æ ‡è®°</strong>ã€‚</li>
</ul>
</li>
</ol>
<p><strong>ä»£ç ç‰‡æ®µç¤ºä¾‹ (Pydantic Schema)</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">field_validator</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="k">class</span> <span class="nc">EntityIR</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">qid</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">label</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">aliases</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">facts</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span> <span class="c1"># {&quot;P569&quot;: &quot;1893-12-26&quot;, ...}</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">fallback_label</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Label is mandatory&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<span class="c1"># ä½¿ç”¨</span>
<span class="c1"># raw_item = {&quot;item&quot;: {&quot;value&quot;: &quot;http://.../Q1&quot;}, &quot;itemLabel&quot;: {&quot;value&quot;: &quot;Universe&quot;}}</span>
<span class="c1"># ir_obj = EntityIR(qid=&quot;Q1&quot;, label=&quot;Universe&quot;, ...)</span>
</code></pre></div>

<h3 id="23-the-generator">2.3 é˜¶æ®µä¸‰ï¼šç”Ÿæˆå™¨ (The Generator)</h3>
<p><strong>æ ¸å¿ƒæŒ‘æˆ˜</strong>ï¼šå¦‚ä½•ä¿è¯å¤šæ ·æ€§ï¼ŒåŒæ—¶ä¿æŒäº‹å®å‡†ç¡®ï¼Ÿ</p>
<p><strong>å·¥ç¨‹å®è·µ</strong>ï¼š</p>
<ol>
<li><strong>æ¨¡æ¿ä¸é€»è¾‘åˆ†ç¦»</strong>ï¼š<ul>
<li>ä¸è¦åœ¨ Python ä»£ç é‡Œå†™ <code>f"ä½ å¥½ï¼Œ{name}"</code>ã€‚</li>
<li>ä½¿ç”¨ <code>Jinja2</code> æ¨¡æ¿å¼•æ“ã€‚è¿™å…è®¸éç¨‹åºå‘˜ï¼ˆå¦‚è¯­è¨€å­¦å®¶ï¼‰ä¿®æ”¹è¯æœ¯è€Œä¸åŠ¨ä»£ç ã€‚</li>
</ul>
</li>
<li><strong>ç¡®å®šæ€§éšæœº (Deterministic Randomness)</strong>ï¼š<ul>
<li><strong>é“å¾‹</strong>ï¼šç”Ÿæˆå™¨çš„è¾“å…¥ç›¸åŒæ—¶ï¼Œè¾“å‡ºå¿…é¡»å®Œå…¨ä¸€è‡´ã€‚</li>
<li><strong>åšæ³•</strong>ï¼šä½¿ç”¨ <code>random.Random(seed=qid_hash)</code>ã€‚</li>
<li><strong>åœºæ™¯</strong>ï¼šå¦‚æœä¸è¿™æ ·åšï¼Œä½ ä¸ºäº†ä¿®å¤ç¬¬ 1000 æ¡æ•°æ®çš„é”™åˆ«å­—é‡è·‘ä»£ç ï¼Œç»“æœç¬¬ 1 æ¡æ•°æ®çš„é—®æ³•å˜äº†ï¼Œå¯¼è‡´ä½ éœ€è¦é‡æ–°äººå·¥å®¡æ ¸æ‰€æœ‰æ•°æ®ã€‚</li>
</ul>
</li>
<li><strong>å…ƒæ•°æ®æ³¨å…¥</strong>ï¼š<ul>
<li>ç”Ÿæˆçš„æ¯ä¸€è¡Œæ•°æ®ï¼Œå¿…é¡»æºå¸¦ <code>source_qid</code> å’Œ <code>provenance</code>ï¼ˆæ¥æºï¼‰ï¼Œä¾¿äºæº¯æºã€‚</li>
</ul>
</li>
</ol>
<h3 id="24-validator-loader">2.4 é˜¶æ®µå››ï¼šéªŒè¯ä¸è½åœ° (Validator &amp; Loader)</h3>
<p><strong>æ ¸å¿ƒæŒ‘æˆ˜</strong>ï¼šç”Ÿæˆäº† 10 ä¸‡æ¡æ•°æ®ï¼Œé‡Œé¢æ··è¿›å»äº†ä¹±ç æˆ–æ•æ„Ÿå†…å®¹æ€ä¹ˆåŠï¼Ÿ</p>
<p><strong>å·¥ç¨‹å®è·µ</strong>ï¼š</p>
<ol>
<li><strong>é˜»å¡å¼æ£€æŸ¥</strong>ï¼šJSON æ ¼å¼é”™è¯¯ã€å¿…å¡«å­—æ®µç¼ºå¤± -&gt; <strong>æŠ¥é”™å¹¶åœæ­¢</strong>ã€‚</li>
<li><strong>ç»Ÿè®¡å¼æ£€æŸ¥</strong>ï¼š<ul>
<li>è®¡ç®—<strong>å¹³å‡é•¿åº¦</strong>ã€<strong>è¯æ±‡ä¸°å¯Œåº¦</strong>ã€‚</li>
<li>æ£€æŸ¥<strong>é‡å¤ç‡</strong>ï¼ˆSimHash æˆ– MinHashï¼‰ã€‚</li>
</ul>
</li>
<li><strong>æ ¼å¼è½åœ°</strong>ï¼š<ul>
<li>æ¨è <code>JSONL</code> (JSON Lines) ç”¨äºæ–‡æœ¬æ•°æ®ï¼Œæ–¹ä¾¿ <code>head</code> / <code>tail</code> æŸ¥çœ‹ã€‚</li>
<li>æ¨è <code>Parquet</code> ç”¨äºå­˜å‚¨ä¸­é—´ç»“æ„åŒ–æ•°æ®ï¼ˆä½“ç§¯å°ï¼ŒPandasè¯»å–å¿«ï¼‰ã€‚</li>
</ul>
</li>
</ol>
<hr />
<h2 id="3">3. è´¨é‡ä¿éšœï¼šé˜²æ­¢â€œä»£ç è…çƒ‚â€</h2>
<p>åœ¨æ•°æ®å·¥ç¨‹ä¸­ï¼Œæœ€å¯æ€•çš„ä¸æ˜¯ä»£ç æŠ¥é”™ï¼Œè€Œæ˜¯<strong>ä»£ç æ²¡æŠ¥é”™ï¼Œä½†æ•°æ®è´¨é‡æ‚„æ‚„ä¸‹é™äº†</strong>ã€‚</p>
<h3 id="31-unit-tests">3.1 å•å…ƒæµ‹è¯• (Unit Tests)</h3>
<p>æµ‹è¯•<strong>å‡½æ•°çº§</strong>é€»è¾‘ã€‚</p>
<ul>
<li><code>test_date_parser.py</code>: è¾“å…¥ <code>+1893-00-00T00:00:00Z</code>ï¼Œæ–­è¨€è¾“å‡º <code>1893å¹´</code>ã€‚</li>
<li><code>test_template.py</code>: è¾“å…¥åŒ…å«ç‰¹æ®Šç¬¦å·çš„åå­— <code>C++ Standard</code>ï¼Œæ–­è¨€æ¨¡æ¿æ²¡æœ‰å´©æºƒæˆ–ä¹±ç ã€‚</li>
</ul>
<h3 id="32-golden-set-regression">3.2 é»„é‡‘é›†å›å½’æµ‹è¯• (Golden Set Regression)</h3>
<p>è¿™æ˜¯é’ˆå¯¹ç”Ÿæˆæ•ˆæœæœ€é‡è¦çš„æµ‹è¯•ã€‚</p>
<ol>
<li><strong>é€‰æ ·</strong>ï¼šæŒ‘é€‰ 50 ä¸ªè¦†ç›–å„ç±»è¾¹ç¼˜æƒ…å†µçš„å®ä½“ï¼ˆå¦‚ï¼šæ²¡æœ‰ä¸­æ–‡åçš„ã€åå­—å¾ˆé•¿çš„ã€å…¬å…ƒå‰çš„ã€æœ‰æ­§ä¹‰çš„ï¼‰ã€‚</li>
<li><strong>é”å®š</strong>ï¼šäººå·¥ç¡®è®¤è¿™ 50 ä¸ªå®ä½“çš„ç”Ÿæˆç»“æœæ˜¯å®Œç¾çš„ï¼Œå­˜ä¸º <code>tests/goldens/expected_output.jsonl</code>ã€‚</li>
<li><strong>è‡ªåŠ¨åŒ–å¯¹æ¯”</strong>ï¼š<ul>
<li>æ¯æ¬¡ Git Push å‰ï¼Œè„šæœ¬è‡ªåŠ¨è·‘è¿™ 50 ä¸ªå®ä½“ã€‚</li>
<li>å¯¹æ¯”æ–°æ—§è¾“å‡ºã€‚</li>
<li><strong>Diff æŠ¥è­¦</strong>ï¼šå¦‚æœå‘ç°å·®å¼‚ï¼Œå±•ç¤º Diffã€‚</li>
<li><strong>å†³ç­–</strong>ï¼š<ul>
<li>æ˜¯æ„å¤–ç ´åäº†é€»è¾‘ï¼Ÿ-&gt; å›æ»šä»£ç ã€‚</li>
<li>æ˜¯ä¼˜åŒ–äº†æ¨¡æ¿ï¼Ÿ-&gt; <code>git commit</code> æ›´æ–° Golden Setã€‚</li>
</ul>
</li>
</ul>
</li>
</ol>
<hr />
<h2 id="4">4. ç‰ˆæœ¬ç®¡ç†ä¸å¯å¤ç°æ€§</h2>
<p>å½“ä½ å‘å¸ƒ <code>v1.0</code> æ•°æ®é›†æ—¶ï¼Œå¿…é¡»èƒ½å›ç­”ï¼šå®ƒæ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿ</p>
<p>å»ºè®®åœ¨æœ€ç»ˆæ•°æ®çš„ Header æˆ–å•ç‹¬çš„ <code>manifest.json</code> ä¸­è®°å½•ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;dataset_version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;v1.0.0&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;created_at&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2023-10-27T10:00:00Z&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;lineage&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;code_commit_sha&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;a1b2c3d4e5...&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;config_hash&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;f6g7h8i9...&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;wikidata_snapshot_date&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2023-10-20&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;stats&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;total_dialogues&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">15420</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;unique_entities&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">5000</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Rule of Thumb</strong>ï¼šå¦‚æœåªæœ‰æ•°æ®æ²¡æœ‰ Config å’Œ Commit Hashï¼Œè¿™å †æ•°æ®å°±æ˜¯åƒåœ¾ï¼Œå› ä¸ºå®ƒä¸å¯å¤ç°ï¼Œæ— æ³•è¿­ä»£ã€‚</p>
<hr />
<h2 id="_2">æœ¬ç« å°ç»“</h2>
<ul>
<li><strong>æ¶æ„åˆ†å±‚</strong>ï¼šSampler è´Ÿè´£ç½‘ç»œï¼ŒNormalizer è´Ÿè´£æ¸…æ´—ï¼ˆPydanticï¼‰ï¼ŒGenerator è´Ÿè´£åˆæˆï¼ˆJinja2/Promptï¼‰ï¼ŒValidator è´Ÿè´£è´¨æ£€ã€‚</li>
<li><strong>æ–­ç‚¹ç»­è·‘</strong>ï¼šåˆ©ç”¨æ–‡ä»¶ç¼“å­˜å’Œä»»åŠ¡é˜Ÿåˆ—ï¼Œé¿å…å› ç½‘ç»œæ³¢åŠ¨å‰åŠŸå°½å¼ƒã€‚</li>
<li><strong>é˜²é€€åŒ–</strong>ï¼šé€šè¿‡â€œé‡‘æ ·å›å½’æµ‹è¯•â€ç¡®ä¿ä¿®æ”¹æ¨¡æ¿ä¸ä¼šç ´åç°æœ‰è´¨é‡ã€‚</li>
<li><strong>ç¡®å®šæ€§</strong>ï¼šå›ºå®šéšæœºæ•°ç§å­ï¼Œç¡®ä¿æµæ°´çº¿æ˜¯å¹‚ç­‰çš„å¯å¤ç°çš„ã€‚</li>
</ul>
<hr />
<h2 id="_3">ç»ƒä¹ é¢˜</h2>
<h3 id="_4">åŸºç¡€é¢˜</h3>
<details>
<summary><strong>ä¹ é¢˜ 1ï¼šç¼–å†™ä¸€ä¸ªå¥å£®çš„æ–‡ä»¶å†™å…¥å™¨</strong></summary>
<p><strong>é¢˜ç›®</strong>ï¼š
åœ¨æ•°æ®å¤„ç†ä¸­ï¼Œå¦‚æœç¨‹åºå†™æ–‡ä»¶å†™åˆ°ä¸€åŠå´©æºƒï¼Œä¼šç•™ä¸‹æŸåçš„æ–‡ä»¶ã€‚
è¯·ç¼–å†™ä¸€ä¸ªå‡½æ•° <code>safe_write_jsonl(data, filename)</code>ï¼Œè¦æ±‚ï¼š</p>
<ol>
<li>å…ˆå†™å…¥ä¸´æ—¶æ–‡ä»¶ <code>filename.tmp</code>ã€‚</li>
<li>å†™å…¥å®Œæˆåï¼Œå†é‡å‘½åä¸º <code>filename</code>ï¼ˆåŸå­æ“ä½œï¼‰ã€‚</li>
<li>åŒ…å«å¼‚å¸¸å¤„ç†ã€‚</li>
</ol>
<p><strong>æç¤º</strong>ï¼šä½¿ç”¨ <code>os.replace</code> (Windows/Linux å…¼å®¹çš„åŸå­ç§»åŠ¨)ã€‚</p>
<details>
<summary><strong>å‚è€ƒç­”æ¡ˆ</strong></summary>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="k">def</span> <span class="nf">safe_write_jsonl</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">temp_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.tmp&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># åŸå­æ›¿æ¢ï¼šè¦ä¹ˆæˆåŠŸï¼Œè¦ä¹ˆæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¸ä¼šå‡ºç°å†™ä¸€åŠçš„æ–‡ä»¶</span>
        <span class="n">os</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully wrote to </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to write file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">)</span> <span class="c1"># æ¸…ç†åƒåœ¾</span>
        <span class="k">raise</span>
</code></pre></div>

</details>
</details>
<details>
<summary><strong>ä¹ é¢˜ 2ï¼šPydantic æ ¡éªŒç»ƒä¹ </strong></summary>
<p><strong>é¢˜ç›®</strong>ï¼š
å®šä¹‰ä¸€ä¸ª Pydantic æ¨¡å‹ <code>ConversationTurn</code>ï¼Œè¦æ±‚ï¼š</p>
<ol>
<li><code>role</code>: åªèƒ½æ˜¯ "user" æˆ– "bot"ã€‚</li>
<li><code>content</code>: å­—ç¬¦ä¸²ï¼Œé•¿åº¦å¿…é¡»å¤§äº 2ã€‚</li>
<li><code>confidence</code>: æµ®ç‚¹æ•°ï¼Œ0.0 åˆ° 1.0 ä¹‹é—´ï¼Œé»˜è®¤ 1.0ã€‚</li>
</ol>
<details>
<summary><strong>å‚è€ƒç­”æ¡ˆ</strong></summary>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">field_validator</span><span class="p">,</span> <span class="n">Field</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span>

<span class="k">class</span> <span class="nc">ConversationTurn</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">role</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;bot&quot;</span><span class="p">]</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">min_length</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># é•¿åº¦&gt;2ï¼Œå³æœ€å°3</span>
    <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

<span class="c1"># æµ‹è¯•</span>
<span class="c1"># t = ConversationTurn(role=&quot;user&quot;, content=&quot;hi&quot;, confidence=0.9) # æŠ¥é”™ï¼šcontentå¤ªçŸ­</span>
<span class="c1"># t = ConversationTurn(role=&quot;system&quot;, content=&quot;hello&quot;) # æŠ¥é”™ï¼šrole ä¸åˆæ³•</span>
</code></pre></div>

</details>
</details>
<h3 id="_5">æŒ‘æˆ˜é¢˜</h3>
<details>
<summary><strong>ä¹ é¢˜ 3ï¼šè®¾è®¡ä¸€ä¸ªåŸºäºæ–‡ä»¶å“ˆå¸Œçš„æ–­ç‚¹ç»­è·‘å™¨</strong></summary>
<p><strong>é¢˜ç›®</strong>ï¼š
ä½ éœ€è¦å¤„ç† 100 ä¸ªå¤§ä»»åŠ¡ï¼ˆtask_id: 1~100ï¼‰ã€‚
è¯·è®¾è®¡ä¸€ä¸ªç®€å•çš„ TaskManager ç±»ï¼š</p>
<ol>
<li>æ¥å—ä¸€ä¸ªä»»åŠ¡åˆ—è¡¨ã€‚</li>
<li>æ£€æŸ¥ output ç›®å½•ä¸‹æ˜¯å¦å·²ç»å­˜åœ¨ <code>result_{task_id}.json</code>ã€‚</li>
<li>å¦‚æœå­˜åœ¨ä¸”æ–‡ä»¶å®Œæ•´ï¼ˆè¿™é‡Œç®€å•åˆ¤æ–­æ–‡ä»¶ä¸ä¸ºç©ºï¼‰ï¼Œè·³è¿‡è¯¥ä»»åŠ¡ã€‚</li>
<li>æä¾›ä¸€ä¸ªè¿›åº¦æ¡ï¼ˆä½¿ç”¨ <code>tqdm</code>ï¼‰ã€‚</li>
</ol>
<p><strong>æç¤º</strong>ï¼šåˆ©ç”¨ Python çš„ <code>pathlib</code> å’Œ <code>tqdm</code>ã€‚</p>
<details>
<summary><strong>å‚è€ƒç­”æ¡ˆ</strong></summary>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">TaskManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_ids</span><span class="p">,</span> <span class="n">process_func</span><span class="p">):</span>
        <span class="c1"># 1. è¿‡æ»¤å·²å®Œæˆçš„ä»»åŠ¡</span>
        <span class="n">todos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="n">task_ids</span><span class="p">:</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;result_</span><span class="si">{</span><span class="n">tid</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>
            <span class="c1"># ç®€å•æ£€æŸ¥ï¼šæ–‡ä»¶å­˜åœ¨ä¸”å¤§å°&gt;0</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">todos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipped </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">task_ids</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">todos</span><span class="p">)</span><span class="si">}</span><span class="s2"> tasks. Processing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">todos</span><span class="p">)</span><span class="si">}</span><span class="s2"> tasks...&quot;</span><span class="p">)</span>

        <span class="c1"># 2. å¤„ç†å‰©ä½™ä»»åŠ¡</span>
        <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">todos</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">process_func</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>
                <span class="c1"># å†™å…¥ç»“æœ</span>
                <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;result_</span><span class="si">{</span><span class="n">tid</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">))</span> <span class="c1"># ç®€åŒ–å†™å…¥</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Task </span><span class="si">{</span><span class="n">tid</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># æ¨¡æ‹Ÿå¤„ç†å‡½æ•°</span>
<span class="k">def</span> <span class="nf">mock_worker</span><span class="p">(</span><span class="n">tid</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">tid</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;done&quot;</span><span class="p">}</span>

<span class="c1"># è¿è¡Œ</span>
<span class="n">mgr</span> <span class="o">=</span> <span class="n">TaskManager</span><span class="p">(</span><span class="s2">&quot;./output_buffer&quot;</span><span class="p">)</span>
<span class="n">mgr</span><span class="o">.</span><span class="n">process_tasks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">mock_worker</span><span class="p">)</span>
</code></pre></div>

</details>
</details>
<hr />
<h2 id="gotchas">å¸¸è§é™·é˜±ä¸é”™è¯¯ (Gotchas)</h2>
<h3 id="1-oom">1. å†…å­˜æº¢å‡º (OOM)</h3>
<ul>
<li><strong>é”™è¯¯åšæ³•</strong>ï¼š<code>all_data = []</code>ï¼Œç„¶ååœ¨å¾ªç¯é‡ŒæŠŠ 100 ä¸‡æ¡æ•°æ® append è¿›å»ï¼Œæœ€åä¸€æ¬¡æ€§ writeã€‚</li>
<li><strong>åæœ</strong>ï¼šè·‘åˆ° 80% æ—¶å†…å­˜çˆ†äº†ï¼Œç¨‹åºè¢« Killï¼Œæ‰€æœ‰æ•°æ®ä¸¢å¤±ã€‚</li>
<li><strong>ä¿®æ­£</strong>ï¼šä½¿ç”¨<strong>æµå¼å¤„ç†</strong>ï¼ˆGenerator/Iteratorï¼‰ã€‚æ¯å¤„ç†ä¸€æ¡ï¼ˆæˆ–ä¸€ä¸ª Batchï¼‰ï¼Œå°± yield å‡ºæ¥å†™å…¥æ–‡ä»¶ã€‚</li>
</ul>
<h3 id="2">2. å¤šè¿›ç¨‹çš„æ–‡ä»¶é”å†²çª</h3>
<ul>
<li><strong>é”™è¯¯åšæ³•</strong>ï¼šå¼€å¯ 8 ä¸ªè¿›ç¨‹å¹¶è¡Œå¤„ç†ï¼Œç»“æœå®ƒä»¬è¯•å›¾åŒæ—¶å†™å…¥åŒä¸€ä¸ª <code>output.jsonl</code> æ–‡ä»¶ã€‚</li>
<li><strong>åæœ</strong>ï¼šæ–‡ä»¶å†…å®¹äº¤é”™ä¹±ç ï¼ŒJSON æ ¼å¼æŸåã€‚</li>
<li><strong>ä¿®æ­£</strong>ï¼š<ul>
<li>æ–¹æ¡ˆ Aï¼šæ¯ä¸ªè¿›ç¨‹å†™è‡ªå·±çš„æ–‡ä»¶ <code>part_1.jsonl</code>, <code>part_2.jsonl</code>ï¼Œæœ€ååˆå¹¶ã€‚</li>
<li>æ–¹æ¡ˆ Bï¼šä½¿ç”¨ä¸»è¿›ç¨‹è´Ÿè´£å†™ï¼ˆReceiverï¼‰ï¼Œå­è¿›ç¨‹åªè´Ÿè´£å¤„ç†å¹¶é€šè¿‡ Queue å‘é€ç»“æœã€‚</li>
</ul>
</li>
</ul>
<h3 id="3_1">3. æ—¶é—´ä¸æ—¶åŒºçš„æ³¥æ½­</h3>
<ul>
<li><strong>é”™è¯¯åšæ³•</strong>ï¼šåœ¨ä»£ç é‡Œå‡è®¾ <code>date</code> éƒ½æ˜¯ "YYYY-MM-DD"ã€‚</li>
<li><strong>ç°å®</strong>ï¼šWikidata æœ‰ "18ä¸–çºª" (precision=8), "2020s" (precision=8), "å…¬å…ƒå‰200å¹´"ã€‚</li>
<li><strong>ä¿®æ­£</strong>ï¼šå¿…é¡»æ£€æŸ¥ Wikidata æ—¶é—´å€¼çš„ <code>precision</code> å­—æ®µã€‚ä¸è¦ç›²ç›®è½¬åŒ–ä¸º Python <code>datetime</code> å¯¹è±¡ï¼Œæœ‰æ—¶ä¿ç•™åŸå§‹å­—ç¬¦ä¸²æ›´å®‰å…¨ã€‚</li>
</ul>
<hr />
<p><a href="chapter10.html">&lt; Chapter 10ï¼šè®¸å¯ä¸åˆè§„</a> | <a href="chapter12.html">Appendicesï¼šæŸ¥è¯¢æ¨¡æ¿åº“ä¸é€ŸæŸ¥è¡¨ &gt;</a></p>
            </article>
            
            <nav class="page-nav"><a href="chapter10.html" class="nav-link prev">â† Chapter 10ï¼šè®¸å¯ä¸åˆè§„ï¼šWikidata CC0 ä¸å¯¹è¯æ•°æ®å‘å¸ƒæ³¨æ„äº‹é¡¹</a><a href="chapter12.html" class="nav-link next">Chapter 12ï¼šæŸ¥è¯¢æ¨¡æ¿åº“ä¸é€ŸæŸ¥è¡¨ (Appendices) â†’</a></nav>
        </main>
    </div>
</body>
</html>